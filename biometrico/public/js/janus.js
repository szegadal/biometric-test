Janus.sessions={},Janus.isExtensionEnabled=function(){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){var chromever=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),maxver=33;return window.navigator.userAgent.match("Linux")&&(maxver=35),!!(26<=chromever&&chromever<=maxver)||Janus.extension.isInstalled()}return!0};var defaultExtension={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return null!==document.querySelector("#janus-extension-installed")},getScreen:function(callback){var pending=window.setTimeout(function(){return error=new Error("NavigatorUserMediaError"),error.name="The required Chrome extension is not installed: click <a href=\"#\">here</a> to install it. (NOTE: this will need you to refresh the page)",callback(error)},1e3);this.cache[pending]=callback,window.postMessage({type:"janusGetScreen",id:pending},"*")},init:function(){var cache={};this.cache=cache,window.addEventListener("message",function(event){if(event.origin==window.location.origin)if("janusGotScreen"==event.data.type&&cache[event.data.id]){var callback=cache[event.data.id];if(delete cache[event.data.id],""===event.data.sourceId){var error=new Error("NavigatorUserMediaError");error.name="You cancelled the request for permission, giving up...",callback(error)}else callback(null,event.data.sourceId)}else"janusGetScreenPending"==event.data.type&&(console.log("clearing ",event.data.id),window.clearTimeout(event.data.id))})}};Janus.useDefaultDependencies=function(deps){var f=deps&&deps.fetch||fetch,p=deps&&deps.Promise||Promise,socketCls=deps&&deps.WebSocket||WebSocket;return{newWebSocket:function(server,proto){return new socketCls(server,proto)},extension:deps&&deps.extension||defaultExtension,isArray:function(arr){return Array.isArray(arr)},webRTCAdapter:deps&&deps.adapter||adapter,httpAPICall:function(url,options){var fetchOptions={method:options.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===options.verb&&(fetchOptions.headers["Content-Type"]="application/json"),void 0!==options.withCredentials&&(fetchOptions.credentials=!0===options.withCredentials?"include":options.withCredentials?options.withCredentials:"omit"),void 0!==options.body&&(fetchOptions.body=JSON.stringify(options.body));var fetching=f(url,fetchOptions).catch(function(error){return p.reject({message:"Probably a network error, is the server down?",error:error})});if(void 0!==options.timeout){var timeout=new p(function(resolve,reject){var timerId=setTimeout(function(){return clearTimeout(timerId),reject({message:"Request timed out",timeout:options.timeout})},options.timeout)});fetching=p.race([fetching,timeout])}return fetching.then(function(response){return response.ok?typeof options.success==typeof Janus.noop?response.json().then(function(parsed){options.success(parsed)}).catch(function(error){return p.reject({message:"Failed to parse response body",error:error,response:response})}):void 0:p.reject({message:"API call failed",response:response})}).catch(function(error){typeof options.error==typeof Janus.noop&&options.error(error.message||"<< internal error >>",error)}),fetching}}},Janus.useOldDependencies=function(deps){var jq=deps&&deps.jQuery||jQuery,socketCls=deps&&deps.WebSocket||WebSocket;return{newWebSocket:function(server,proto){return new socketCls(server,proto)},isArray:function(arr){return jq.isArray(arr)},extension:deps&&deps.extension||defaultExtension,webRTCAdapter:deps&&deps.adapter||adapter,httpAPICall:function(url,options){var payload=options.body===void 0?{}:{contentType:"application/json",data:JSON.stringify(options.body)},credentials=options.withCredentials===void 0?{}:{xhrFields:{withCredentials:options.withCredentials}};return jq.ajax(jq.extend(payload,credentials,{url:url,type:options.verb,cache:!1,dataType:"json",async:options.async,timeout:options.timeout,success:function(result){typeof options.success==typeof Janus.noop&&options.success(result)},error:function(xhr,status,err){typeof options.error==typeof Janus.noop&&options.error(status,err)}}))}}},Janus.noop=function(){},Janus.init=function(options){if(options=options||{},options.callback="function"==typeof options.callback?options.callback:Janus.noop,!0===Janus.initDone)options.callback();else{if(("undefined"==typeof console||"undefined"==typeof console.log)&&(console={log:function(){}}),Janus.trace=Janus.noop,Janus.debug=Janus.noop,Janus.vdebug=Janus.noop,Janus.log=Janus.noop,Janus.warn=Janus.noop,Janus.error=Janus.noop,!0===options.debug||"all"===options.debug)Janus.trace=console.trace.bind(console),Janus.debug=console.debug.bind(console),Janus.vdebug=console.debug.bind(console),Janus.log=console.log.bind(console),Janus.warn=console.warn.bind(console),Janus.error=console.error.bind(console);else if(Array.isArray(options.debug))for(var i in options.debug){var d=options.debug[i];"trace"===d?Janus.trace=console.trace.bind(console):"debug"===d?Janus.debug=console.debug.bind(console):"vdebug"===d?Janus.vdebug=console.debug.bind(console):"log"===d?Janus.log=console.log.bind(console):"warn"===d?Janus.warn=console.warn.bind(console):"error"===d?Janus.error=console.error.bind(console):console.error("Unknown debugging option '"+d+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}Janus.log("Initializing library");var usedDependencies=options.dependencies||Janus.useDefaultDependencies();Janus.isArray=usedDependencies.isArray,Janus.webRTCAdapter=usedDependencies.webRTCAdapter,Janus.httpAPICall=usedDependencies.httpAPICall,Janus.newWebSocket=usedDependencies.newWebSocket,Janus.extension=usedDependencies.extension,Janus.extension.init(),Janus.listDevices=function(callback,config){callback="function"==typeof callback?callback:Janus.noop,null==config&&(config={audio:!0,video:!0}),navigator.mediaDevices?navigator.mediaDevices.getUserMedia(config).then(function(stream){navigator.mediaDevices.enumerateDevices().then(function(devices){Janus.debug(devices),callback(devices);try{var tracks=stream.getTracks();for(var i in tracks){var mst=tracks[i];null!==mst&&void 0!==mst&&mst.stop()}}catch(e){}})}).catch(function(err){Janus.error(err),callback([])}):(Janus.warn("navigator.mediaDevices unavailable"),callback([]))},Janus.attachMediaStream=function(element,stream){if("chrome"===Janus.webRTCAdapter.browserDetails.browser){var chromever=Janus.webRTCAdapter.browserDetails.version;52<=chromever?element.srcObject=stream:"undefined"==typeof element.src?Janus.error("Error attaching stream to element"):element.src=URL.createObjectURL(stream)}else element.srcObject=stream},Janus.reattachMediaStream=function(to,from){if("chrome"===Janus.webRTCAdapter.browserDetails.browser){var chromever=Janus.webRTCAdapter.browserDetails.version;52<=chromever?to.srcObject=from.srcObject:"undefined"==typeof to.src?Janus.error("Error reattaching stream to element"):to.src=from.src}else to.srcObject=from.srcObject};var iOS=0<=["iPad","iPhone","iPod"].indexOf(navigator.platform),eventName=iOS?"pagehide":"beforeunload",oldOBF=window["on"+eventName];if(window.addEventListener(eventName,function(){for(var s in Janus.log("Closing window"),Janus.sessions)null!==Janus.sessions[s]&&void 0!==Janus.sessions[s]&&Janus.sessions[s].destroyOnUnload&&(Janus.log("Destroying session "+s),Janus.sessions[s].destroy({asyncRequest:!1,notifyDestroyed:!1}));oldOBF&&"function"==typeof oldOBF&&oldOBF()}),Janus.safariVp8=!1,"safari"===Janus.webRTCAdapter.browserDetails.browser&&605<=Janus.webRTCAdapter.browserDetails.version)if(RTCRtpSender&&RTCRtpSender.getCapabilities&&RTCRtpSender.getCapabilities("video")&&RTCRtpSender.getCapabilities("video").codecs&&RTCRtpSender.getCapabilities("video").codecs.length){for(var i in RTCRtpSender.getCapabilities("video").codecs){var codec=RTCRtpSender.getCapabilities("video").codecs[i];if(codec&&codec.mimeType&&"video/vp8"===codec.mimeType.toLowerCase()){Janus.safariVp8=!0;break}}Janus.safariVp8?Janus.log("This version of Safari supports VP8"):Janus.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, "+"try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else{var testpc=new RTCPeerConnection({},{});testpc.createOffer({offerToReceiveVideo:!0}).then(function(offer){Janus.safariVp8=-1!==offer.sdp.indexOf("VP8"),Janus.safariVp8?Janus.log("This version of Safari supports VP8"):Janus.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, "+"try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu"),testpc.close(),testpc=null})}Janus.initDone=!0,options.callback()}},Janus.isWebrtcSupported=function(){return window.RTCPeerConnection!==void 0&&null!==window.RTCPeerConnection&&navigator.getUserMedia!==void 0&&null!==navigator.getUserMedia},Janus.randomString=function(len){for(var randomPoz,charSet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",randomString="",i=0;i<len;i++)randomPoz=Math.floor(Math.random()*charSet.length),randomString+=charSet.substring(randomPoz,randomPoz+1);return randomString};function Janus(gatewayCallbacks){function eventHandler(){if(null!=sessionId){if(Janus.debug("Long poll..."),!connected)return void Janus.warn("Is the server down? (connected=false)");var longpoll=server+"/"+sessionId+"?rid="+new Date().getTime();void 0!==maxev&&null!==maxev&&(longpoll=longpoll+"&maxev="+maxev),null!==token&&void 0!==token&&(longpoll=longpoll+"&token="+encodeURIComponent(token)),null!==apisecret&&void 0!==apisecret&&(longpoll=longpoll+"&apisecret="+encodeURIComponent(apisecret)),Janus.httpAPICall(longpoll,{verb:"GET",withCredentials:withCredentials,success:handleEvent,timeout:longPollTimeout,error:function(textStatus,errorThrown){return Janus.error(textStatus+":",errorThrown),retries++,3<retries?(connected=!1,void gatewayCallbacks.error("506")):void eventHandler()}})}}function handleEvent(json,skipTimeout){if(retries=0,websockets||void 0===sessionId||null===sessionId||!0===skipTimeout||eventHandler(),!websockets&&Janus.isArray(json)){for(var i=0;i<json.length;i++)handleEvent(json[i],!0);return}if("keepalive"===json.janus)return void Janus.vdebug("Got a keepalive on session "+sessionId);if("ack"===json.janus){Janus.debug("Got an ack on session "+sessionId),Janus.debug(json);var transaction=json.transaction;if(null!==transaction&&void 0!==transaction){var reportSuccess=transactions[transaction];null!==reportSuccess&&void 0!==reportSuccess&&reportSuccess(json),delete transactions[transaction]}return}if("success"===json.janus){Janus.debug("Got a success on session "+sessionId),Janus.debug(json);var transaction=json.transaction;if(null!==transaction&&void 0!==transaction){var reportSuccess=transactions[transaction];null!==reportSuccess&&void 0!==reportSuccess&&reportSuccess(json),delete transactions[transaction]}return}if("trickle"===json.janus){var sender=json.sender;if(void 0===sender||null===sender)return void Janus.warn("Missing sender...");var pluginHandle=pluginHandles[sender];if(void 0===pluginHandle||null===pluginHandle)return void Janus.debug("This handle is not attached to this session");var candidate=json.candidate;Janus.debug("Got a trickled candidate on session "+sessionId),Janus.debug(candidate);var config=pluginHandle.webrtcStuff;config.pc&&config.remoteSdp?(Janus.debug("Adding remote candidate:",candidate),candidate&&!0!==candidate.completed?config.pc.addIceCandidate(candidate):config.pc.addIceCandidate()):(Janus.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),!config.candidates&&(config.candidates=[]),config.candidates.push(candidate),Janus.debug(config.candidates))}else{if("webrtcup"===json.janus){Janus.debug("Got a webrtcup event on session "+sessionId),Janus.debug(json);var sender=json.sender;if(void 0===sender||null===sender)return void Janus.warn("Missing sender...");var pluginHandle=pluginHandles[sender];return void 0===pluginHandle||null===pluginHandle?void Janus.debug("This handle is not attached to this session"):void pluginHandle.webrtcState(!0)}if("hangup"===json.janus){Janus.debug("Got a hangup event on session "+sessionId),Janus.debug(json);var sender=json.sender;if(void 0===sender||null===sender)return void Janus.warn("Missing sender...");var pluginHandle=pluginHandles[sender];if(void 0===pluginHandle||null===pluginHandle)return void Janus.debug("This handle is not attached to this session");pluginHandle.webrtcState(!1,json.reason),pluginHandle.hangup()}else if("detached"===json.janus){Janus.debug("Got a detached event on session "+sessionId),Janus.debug(json);var sender=json.sender;if(void 0===sender||null===sender)return void Janus.warn("Missing sender...");var pluginHandle=pluginHandles[sender];if(void 0===pluginHandle||null===pluginHandle)return;pluginHandle.detached=!0,pluginHandle.ondetached(),pluginHandle.detach()}else if("media"===json.janus){Janus.debug("Got a media event on session "+sessionId),Janus.debug(json);var sender=json.sender;if(void 0===sender||null===sender)return void Janus.warn("Missing sender...");var pluginHandle=pluginHandles[sender];if(void 0===pluginHandle||null===pluginHandle)return void Janus.debug("This handle is not attached to this session");pluginHandle.mediaState(json.type,json.receiving)}else if("slowlink"===json.janus){Janus.debug("Got a slowlink event on session "+sessionId),Janus.debug(json);var sender=json.sender;if(void 0===sender||null===sender)return void Janus.warn("Missing sender...");var pluginHandle=pluginHandles[sender];if(void 0===pluginHandle||null===pluginHandle)return void Janus.debug("This handle is not attached to this session");pluginHandle.slowLink(json.uplink,json.nacks)}else{if("error"===json.janus){Janus.error("Ooops: "+json.error.code+" "+json.error.reason),Janus.debug(json);var transaction=json.transaction;if(null!==transaction&&void 0!==transaction){var reportSuccess=transactions[transaction];null!==reportSuccess&&void 0!==reportSuccess&&reportSuccess(json),delete transactions[transaction]}return}if("event"===json.janus){Janus.debug("Got a plugin event on session "+sessionId),Janus.debug(json);var sender=json.sender;if(void 0===sender||null===sender)return void Janus.warn("Missing sender...");var plugindata=json.plugindata;if(void 0===plugindata||null===plugindata)return void Janus.warn("Missing plugindata...");Janus.debug("  -- Event is coming from "+sender+" ("+plugindata.plugin+")");var data=plugindata.data;Janus.debug(data);var pluginHandle=pluginHandles[sender];if(void 0===pluginHandle||null===pluginHandle)return void Janus.warn("This handle is not attached to this session");var jsep=json.jsep;void 0!==jsep&&null!==jsep&&(Janus.debug("Handling SDP as well..."),Janus.debug(jsep));var callback=pluginHandle.onmessage;null!==callback&&void 0!==callback?(Janus.debug("Notifying application..."),callback(data,jsep)):Janus.debug("No provided notification callback")}else{if("timeout"===json.janus)return Janus.error("Timeout on session "+sessionId),Janus.debug(json),void(websockets&&ws.close(3504,"Gateway timeout"));Janus.warn("Unknown message/event  '"+json.janus+"' on session "+sessionId),Janus.debug(json)}}}}function keepAlive(){if(null!==server&&websockets&&connected){wsKeepaliveTimeoutId=setTimeout(keepAlive,keepAlivePeriod);var request={janus:"keepalive",session_id:sessionId,transaction:Janus.randomString(12)};null!==token&&void 0!==token&&(request.token=token),null!==apisecret&&void 0!==apisecret&&(request.apisecret=apisecret),ws.send(JSON.stringify(request))}}function createSession(callbacks){var transaction=Janus.randomString(12),request={janus:"create",transaction:transaction};if(callbacks.reconnect&&(connected=!1,request.janus="claim",request.session_id=sessionId,ws&&(ws.onopen=null,ws.onerror=null,ws.onclose=null,wsKeepaliveTimeoutId&&(clearTimeout(wsKeepaliveTimeoutId),wsKeepaliveTimeoutId=null))),null!==token&&void 0!==token&&(request.token=token),null!==apisecret&&void 0!==apisecret&&(request.apisecret=apisecret),null===server&&Janus.isArray(servers)&&(server=servers[serversIndex],0===server.indexOf("ws")?(websockets=!0,Janus.log("Server #"+(serversIndex+1)+": trying WebSockets to contact Janus ("+server+")")):(websockets=!1,Janus.log("Server #"+(serversIndex+1)+": trying REST API to contact Janus ("+server+")"))),websockets){for(var eventName in ws=Janus.newWebSocket(server,"janus-protocol"),wsHandlers={error:function(){return(Janus.error("Error connecting to the Janus WebSockets server... "+server),Janus.isArray(servers)&&!callbacks.reconnect)?(serversIndex++,serversIndex==servers.length)?void callbacks.error("Error connecting to any of the provided Janus servers: Is the server down?"):(server=null,void setTimeout(function(){createSession(callbacks)},200)):void callbacks.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){transactions[transaction]=function(json){return Janus.debug(json),"success"===json.janus?void(wsKeepaliveTimeoutId=setTimeout(keepAlive,keepAlivePeriod),connected=!0,sessionId=json.session_id?json.session_id:json.data.id,callbacks.reconnect?Janus.log("Claimed session: "+sessionId):Janus.log("Created session: "+sessionId),Janus.sessions[sessionId]=that,callbacks.success()):(Janus.error("Ooops: "+json.error.code+" "+json.error.reason),void callbacks.error(json.error.reason))},ws.send(JSON.stringify(request))},message:function(event){handleEvent(JSON.parse(event.data))},close:function(){null!==server&&connected&&(connected=!1,gatewayCallbacks.error("506"))}},wsHandlers)ws.addEventListener(eventName,wsHandlers[eventName]);return}Janus.httpAPICall(server,{verb:"POST",withCredentials:withCredentials,body:request,success:function(json){return Janus.debug(json),"success"===json.janus?void(connected=!0,sessionId=json.session_id?json.session_id:json.data.id,callbacks.reconnect?Janus.log("Claimed session: "+sessionId):Janus.log("Created session: "+sessionId),Janus.sessions[sessionId]=that,eventHandler(),callbacks.success()):(Janus.error("Ooops: "+json.error.code+" "+json.error.reason),void callbacks.error(json.error.reason))},error:function(textStatus,errorThrown){return(Janus.error(textStatus+":",errorThrown),Janus.isArray(servers)&&!callbacks.reconnect)?(serversIndex++,serversIndex==servers.length)?void callbacks.error("Error connecting to any of the provided Janus servers: Is the server down?"):(server=null,void setTimeout(function(){createSession(callbacks)},200)):void(""===errorThrown?callbacks.error(textStatus+": Is the server down?"):callbacks.error(textStatus+": "+errorThrown))}})}function destroySession(callbacks){callbacks=callbacks||{},callbacks.success="function"==typeof callbacks.success?callbacks.success:Janus.noop;var asyncRequest=!0;void 0!==callbacks.asyncRequest&&null!==callbacks.asyncRequest&&(asyncRequest=!0===callbacks.asyncRequest);var notifyDestroyed=!0;if(void 0!==callbacks.notifyDestroyed&&null!==callbacks.notifyDestroyed&&(notifyDestroyed=!0===callbacks.notifyDestroyed),Janus.log("Destroying session "+sessionId+" (async="+asyncRequest+")"),!connected)return Janus.warn("Is the server down? (connected=false)"),void callbacks.success();if(void 0===sessionId||null===sessionId)return Janus.warn("No session to destroy"),callbacks.success(),void(notifyDestroyed&&gatewayCallbacks.destroyed());delete Janus.sessions[sessionId];var request={janus:"destroy",transaction:Janus.randomString(12)};if(null!==token&&void 0!==token&&(request.token=token),null!==apisecret&&void 0!==apisecret&&(request.apisecret=apisecret),websockets){request.session_id=sessionId;var unbindWebSocket=function(){for(var eventName in wsHandlers)ws.removeEventListener(eventName,wsHandlers[eventName]);ws.removeEventListener("message",onUnbindMessage),ws.removeEventListener("error",onUnbindError),wsKeepaliveTimeoutId&&clearTimeout(wsKeepaliveTimeoutId),ws.close()},onUnbindMessage=function(event){var data=JSON.parse(event.data);data.session_id==request.session_id&&data.transaction==request.transaction&&(unbindWebSocket(),callbacks.success(),notifyDestroyed&&gatewayCallbacks.destroyed())},onUnbindError=function(event){unbindWebSocket(),callbacks.error("Failed to destroy the server: Is the server down?"),notifyDestroyed&&gatewayCallbacks.destroyed()};return ws.addEventListener("message",onUnbindMessage),ws.addEventListener("error",onUnbindError),void ws.send(JSON.stringify(request))}Janus.httpAPICall(server+"/"+sessionId,{verb:"POST",async:asyncRequest,withCredentials:withCredentials,body:request,success:function(json){Janus.log("Destroyed session:"),Janus.debug(json),sessionId=null,connected=!1,"success"!==json.janus&&Janus.error("Ooops: "+json.error.code+" "+json.error.reason),callbacks.success(),notifyDestroyed&&gatewayCallbacks.destroyed()},error:function(textStatus,errorThrown){Janus.error(textStatus+":",errorThrown),sessionId=null,connected=!1,callbacks.success(),notifyDestroyed&&gatewayCallbacks.destroyed()}})}function createHandle(callbacks){if(callbacks=callbacks||{},callbacks.success="function"==typeof callbacks.success?callbacks.success:Janus.noop,callbacks.error="function"==typeof callbacks.error?callbacks.error:Janus.noop,callbacks.consentDialog="function"==typeof callbacks.consentDialog?callbacks.consentDialog:Janus.noop,callbacks.iceState="function"==typeof callbacks.iceState?callbacks.iceState:Janus.noop,callbacks.mediaState="function"==typeof callbacks.mediaState?callbacks.mediaState:Janus.noop,callbacks.webrtcState="function"==typeof callbacks.webrtcState?callbacks.webrtcState:Janus.noop,callbacks.slowLink="function"==typeof callbacks.slowLink?callbacks.slowLink:Janus.noop,callbacks.onmessage="function"==typeof callbacks.onmessage?callbacks.onmessage:Janus.noop,callbacks.onlocalstream="function"==typeof callbacks.onlocalstream?callbacks.onlocalstream:Janus.noop,callbacks.onremotestream="function"==typeof callbacks.onremotestream?callbacks.onremotestream:Janus.noop,callbacks.ondata="function"==typeof callbacks.ondata?callbacks.ondata:Janus.noop,callbacks.ondataopen="function"==typeof callbacks.ondataopen?callbacks.ondataopen:Janus.noop,callbacks.oncleanup="function"==typeof callbacks.oncleanup?callbacks.oncleanup:Janus.noop,callbacks.ondetached="function"==typeof callbacks.ondetached?callbacks.ondetached:Janus.noop,!connected)return Janus.warn("Is the server down? (connected=false)"),void callbacks.error("Is the server down? (connected=false)");var plugin=callbacks.plugin;if(void 0===plugin||null===plugin)return Janus.error("Invalid plugin"),void callbacks.error("Invalid plugin");var opaqueId=callbacks.opaqueId,handleToken=callbacks.token?callbacks.token:token,transaction=Janus.randomString(12),request={janus:"attach",plugin:plugin,opaque_id:opaqueId,transaction:transaction};return null!==handleToken&&void 0!==handleToken&&(request.token=handleToken),null!==apisecret&&void 0!==apisecret&&(request.apisecret=apisecret),websockets?(transactions[transaction]=function(json){if(Janus.debug(json),"success"!==json.janus)return Janus.error("Ooops: "+json.error.code+" "+json.error.reason),void callbacks.error("Ooops: "+json.error.code+" "+json.error.reason);var handleId=json.data.id;Janus.log("Created handle: "+handleId);var pluginHandle={session:that,plugin:plugin,id:handleId,token:handleToken,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:null,dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return handleId},getPlugin:function(){return plugin},getVolume:function(){return getVolume(handleId,!0)},getRemoteVolume:function(){return getVolume(handleId,!0)},getLocalVolume:function(){return getVolume(handleId,!1)},isAudioMuted:function(){return isMuted(handleId,!1)},muteAudio:function(){return mute(handleId,!1,!0)},unmuteAudio:function(){return mute(handleId,!1,!1)},isVideoMuted:function(){return isMuted(handleId,!0)},muteVideo:function(){return mute(handleId,!0,!0)},unmuteVideo:function(){return mute(handleId,!0,!1)},getBitrate:function(){return getBitrate(handleId)},send:function(callbacks){sendMessage(handleId,callbacks)},data:function(callbacks){sendData(handleId,callbacks)},dtmf:function(callbacks){sendDtmf(handleId,callbacks)},consentDialog:callbacks.consentDialog,iceState:callbacks.iceState,mediaState:callbacks.mediaState,webrtcState:callbacks.webrtcState,slowLink:callbacks.slowLink,onmessage:callbacks.onmessage,createOffer:function(callbacks){prepareWebrtc(handleId,callbacks)},createAnswer:function(callbacks){prepareWebrtc(handleId,callbacks)},handleRemoteJsep:function(callbacks){prepareWebrtcPeer(handleId,callbacks)},onlocalstream:callbacks.onlocalstream,onremotestream:callbacks.onremotestream,ondata:callbacks.ondata,ondataopen:callbacks.ondataopen,oncleanup:callbacks.oncleanup,ondetached:callbacks.ondetached,hangup:function(sendRequest){cleanupWebrtc(handleId,!0===sendRequest)},detach:function(callbacks){destroyHandle(handleId,callbacks)}};pluginHandles[handleId]=pluginHandle,callbacks.success(pluginHandle)},request.session_id=sessionId,void ws.send(JSON.stringify(request))):void Janus.httpAPICall(server+"/"+sessionId,{verb:"POST",withCredentials:withCredentials,body:request,success:function(json){if(Janus.debug(json),"success"!==json.janus)return Janus.error("Ooops: "+json.error.code+" "+json.error.reason),void callbacks.error("Ooops: "+json.error.code+" "+json.error.reason);var handleId=json.data.id;Janus.log("Created handle: "+handleId);var pluginHandle={session:that,plugin:plugin,id:handleId,token:handleToken,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:null,dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return handleId},getPlugin:function(){return plugin},getVolume:function(){return getVolume(handleId,!0)},getRemoteVolume:function(){return getVolume(handleId,!0)},getLocalVolume:function(){return getVolume(handleId,!1)},isAudioMuted:function(){return isMuted(handleId,!1)},muteAudio:function(){return mute(handleId,!1,!0)},unmuteAudio:function(){return mute(handleId,!1,!1)},isVideoMuted:function(){return isMuted(handleId,!0)},muteVideo:function(){return mute(handleId,!0,!0)},unmuteVideo:function(){return mute(handleId,!0,!1)},getBitrate:function(){return getBitrate(handleId)},send:function(callbacks){sendMessage(handleId,callbacks)},data:function(callbacks){sendData(handleId,callbacks)},dtmf:function(callbacks){sendDtmf(handleId,callbacks)},consentDialog:callbacks.consentDialog,iceState:callbacks.iceState,mediaState:callbacks.mediaState,webrtcState:callbacks.webrtcState,slowLink:callbacks.slowLink,onmessage:callbacks.onmessage,createOffer:function(callbacks){prepareWebrtc(handleId,callbacks)},createAnswer:function(callbacks){prepareWebrtc(handleId,callbacks)},handleRemoteJsep:function(callbacks){prepareWebrtcPeer(handleId,callbacks)},onlocalstream:callbacks.onlocalstream,onremotestream:callbacks.onremotestream,ondata:callbacks.ondata,ondataopen:callbacks.ondataopen,oncleanup:callbacks.oncleanup,ondetached:callbacks.ondetached,hangup:function(sendRequest){cleanupWebrtc(handleId,!0===sendRequest)},detach:function(callbacks){destroyHandle(handleId,callbacks)}};pluginHandles[handleId]=pluginHandle,callbacks.success(pluginHandle)},error:function(textStatus,errorThrown){Janus.error(textStatus+":",errorThrown)}})}function sendMessage(handleId,callbacks){if(callbacks=callbacks||{},callbacks.success="function"==typeof callbacks.success?callbacks.success:Janus.noop,callbacks.error="function"==typeof callbacks.error?callbacks.error:Janus.noop,!connected)return Janus.warn("Is the server down? (connected=false)"),void callbacks.error("Is the server down? (connected=false)");var pluginHandle=pluginHandles[handleId];if(null===pluginHandle||void 0===pluginHandle||null===pluginHandle.webrtcStuff||void 0===pluginHandle.webrtcStuff)return Janus.warn("Invalid handle"),void callbacks.error("Invalid handle");var message=callbacks.message,jsep=callbacks.jsep,transaction=Janus.randomString(12),request={janus:"message",body:message,transaction:transaction};return null!==pluginHandle.token&&void 0!==pluginHandle.token&&(request.token=pluginHandle.token),null!==apisecret&&void 0!==apisecret&&(request.apisecret=apisecret),null!==jsep&&void 0!==jsep&&(request.jsep=jsep),Janus.debug("Sending message to plugin (handle="+handleId+"):"),Janus.debug(request),websockets?(request.session_id=sessionId,request.handle_id=handleId,transactions[transaction]=function(json){if(Janus.debug("Message sent!"),Janus.debug(json),"success"===json.janus){var plugindata=json.plugindata;if(void 0===plugindata||null===plugindata)return Janus.warn("Request succeeded, but missing plugindata..."),void callbacks.success();Janus.log("Synchronous transaction successful ("+plugindata.plugin+")");var data=plugindata.data;return Janus.debug(data),void callbacks.success(data)}return"ack"===json.janus?void callbacks.success():void(void 0!==json.error&&null!==json.error?(Janus.error("Ooops: "+json.error.code+" "+json.error.reason),callbacks.error(json.error.code+" "+json.error.reason)):(Janus.error("Unknown error"),callbacks.error("Unknown error")))},void ws.send(JSON.stringify(request))):void Janus.httpAPICall(server+"/"+sessionId+"/"+handleId,{verb:"POST",withCredentials:withCredentials,body:request,success:function(json){if(Janus.debug("Message sent!"),Janus.debug(json),"success"===json.janus){var plugindata=json.plugindata;if(void 0===plugindata||null===plugindata)return Janus.warn("Request succeeded, but missing plugindata..."),void callbacks.success();Janus.log("Synchronous transaction successful ("+plugindata.plugin+")");var data=plugindata.data;return Janus.debug(data),void callbacks.success(data)}return"ack"===json.janus?void callbacks.success():void(void 0!==json.error&&null!==json.error?(Janus.error("Ooops: "+json.error.code+" "+json.error.reason),callbacks.error(json.error.code+" "+json.error.reason)):(Janus.error("Unknown error"),callbacks.error("Unknown error")))},error:function(textStatus,errorThrown){Janus.error(textStatus+":",errorThrown),callbacks.error(textStatus+": "+errorThrown)}})}function sendTrickleCandidate(handleId,candidate){if(!connected)return void Janus.warn("Is the server down? (connected=false)");var pluginHandle=pluginHandles[handleId];if(null===pluginHandle||void 0===pluginHandle||null===pluginHandle.webrtcStuff||void 0===pluginHandle.webrtcStuff)return void Janus.warn("Invalid handle");var request={janus:"trickle",candidate:candidate,transaction:Janus.randomString(12)};return null!==pluginHandle.token&&void 0!==pluginHandle.token&&(request.token=pluginHandle.token),null!==apisecret&&void 0!==apisecret&&(request.apisecret=apisecret),Janus.vdebug("Sending trickle candidate (handle="+handleId+"):"),Janus.vdebug(request),websockets?(request.session_id=sessionId,request.handle_id=handleId,void ws.send(JSON.stringify(request))):void Janus.httpAPICall(server+"/"+sessionId+"/"+handleId,{verb:"POST",withCredentials:withCredentials,body:request,success:function(json){if(Janus.vdebug("Candidate sent!"),Janus.vdebug(json),"ack"!==json.janus)return void Janus.error("Ooops: "+json.error.code+" "+json.error.reason)},error:function(textStatus,errorThrown){Janus.error(textStatus+":",errorThrown)}})}function sendData(handleId,callbacks){callbacks=callbacks||{},callbacks.success="function"==typeof callbacks.success?callbacks.success:Janus.noop,callbacks.error="function"==typeof callbacks.error?callbacks.error:Janus.noop;var pluginHandle=pluginHandles[handleId];if(null===pluginHandle||void 0===pluginHandle||null===pluginHandle.webrtcStuff||void 0===pluginHandle.webrtcStuff)return Janus.warn("Invalid handle"),void callbacks.error("Invalid handle");var config=pluginHandle.webrtcStuff,text=callbacks.text;return null===text||void 0===text?(Janus.warn("Invalid text"),void callbacks.error("Invalid text")):void(Janus.log("Sending string on data channel: "+text),config.dataChannel.send(text),callbacks.success())}function sendDtmf(handleId,callbacks){callbacks=callbacks||{},callbacks.success="function"==typeof callbacks.success?callbacks.success:Janus.noop,callbacks.error="function"==typeof callbacks.error?callbacks.error:Janus.noop;var pluginHandle=pluginHandles[handleId];if(null===pluginHandle||void 0===pluginHandle||null===pluginHandle.webrtcStuff||void 0===pluginHandle.webrtcStuff)return Janus.warn("Invalid handle"),void callbacks.error("Invalid handle");var config=pluginHandle.webrtcStuff;if(null===config.dtmfSender||void 0===config.dtmfSender){if(void 0!==config.pc&&null!==config.pc){var senders=config.pc.getSenders(),audioSender=senders.find(function(sender){return sender.track&&"audio"===sender.track.kind});if(!audioSender)return Janus.warn("Invalid DTMF configuration (no audio track)"),void callbacks.error("Invalid DTMF configuration (no audio track)");config.dtmfSender=audioSender.dtmf,config.dtmfSender&&(Janus.log("Created DTMF Sender"),config.dtmfSender.ontonechange=function(tone){Janus.debug("Sent DTMF tone: "+tone.tone)})}if(null===config.dtmfSender||void 0===config.dtmfSender)return Janus.warn("Invalid DTMF configuration"),void callbacks.error("Invalid DTMF configuration")}var dtmf=callbacks.dtmf;if(null===dtmf||void 0===dtmf)return Janus.warn("Invalid DTMF parameters"),void callbacks.error("Invalid DTMF parameters");var tones=dtmf.tones;if(null===tones||void 0===tones)return Janus.warn("Invalid DTMF string"),void callbacks.error("Invalid DTMF string");var duration=dtmf.duration;(null===duration||void 0===duration)&&(duration=500);var gap=dtmf.gap;(null===gap||void 0===gap)&&(gap=50),Janus.debug("Sending DTMF string "+tones+" (duration "+duration+"ms, gap "+gap+"ms)"),config.dtmfSender.insertDTMF(tones,duration,gap),callbacks.success()}function destroyHandle(handleId,callbacks){callbacks=callbacks||{},callbacks.success="function"==typeof callbacks.success?callbacks.success:Janus.noop,callbacks.error="function"==typeof callbacks.error?callbacks.error:Janus.noop;var asyncRequest=!0;void 0!==callbacks.asyncRequest&&null!==callbacks.asyncRequest&&(asyncRequest=!0===callbacks.asyncRequest),Janus.log("Destroying handle "+handleId+" (async="+asyncRequest+")"),cleanupWebrtc(handleId);var pluginHandle=pluginHandles[handleId];if(null===pluginHandle||void 0===pluginHandle||pluginHandle.detached)return delete pluginHandles[handleId],void callbacks.success();if(!connected)return Janus.warn("Is the server down? (connected=false)"),void callbacks.error("Is the server down? (connected=false)");var request={janus:"detach",transaction:Janus.randomString(12)};return null!==pluginHandle.token&&void 0!==pluginHandle.token&&(request.token=pluginHandle.token),null!==apisecret&&void 0!==apisecret&&(request.apisecret=apisecret),websockets?(request.session_id=sessionId,request.handle_id=handleId,ws.send(JSON.stringify(request)),delete pluginHandles[handleId],void callbacks.success()):void Janus.httpAPICall(server+"/"+sessionId+"/"+handleId,{verb:"POST",async:asyncRequest,withCredentials:withCredentials,body:request,success:function(json){Janus.log("Destroyed handle:"),Janus.debug(json),"success"!==json.janus&&Janus.error("Ooops: "+json.error.code+" "+json.error.reason),delete pluginHandles[handleId],callbacks.success()},error:function(textStatus,errorThrown){Janus.error(textStatus+":",errorThrown),delete pluginHandles[handleId],callbacks.success()}})}function streamsDone(handleId,jsep,media,callbacks,stream){var pluginHandle=pluginHandles[handleId];if(null===pluginHandle||void 0===pluginHandle||null===pluginHandle.webrtcStuff||void 0===pluginHandle.webrtcStuff)return Janus.warn("Invalid handle"),void callbacks.error("Invalid handle");var config=pluginHandle.webrtcStuff;Janus.debug("streamsDone:",stream),stream&&(Janus.debug("  -- Audio tracks:",stream.getAudioTracks()),Janus.debug("  -- Video tracks:",stream.getVideoTracks()));var addTracks=!1;if(!config.myStream||!media.update||config.streamExternal)config.myStream=stream,addTracks=!0;else{if((!media.update&&isAudioSendEnabled(media)||media.update&&(media.addAudio||media.replaceAudio))&&stream.getAudioTracks()&&stream.getAudioTracks().length)if(config.myStream.addTrack(stream.getAudioTracks()[0]),media.replaceAudio&&("firefox"===Janus.webRTCAdapter.browserDetails.browser||"chrome"===Janus.webRTCAdapter.browserDetails.browser&&72<=Janus.webRTCAdapter.browserDetails.version))for(var index in Janus.log("Replacing audio track:",stream.getAudioTracks()[0]),config.pc.getSenders()){var s=config.pc.getSenders()[index];s&&s.track&&"audio"===s.track.kind&&s.replaceTrack(stream.getAudioTracks()[0])}else if("firefox"===Janus.webRTCAdapter.browserDetails.browser&&59<=Janus.webRTCAdapter.browserDetails.version){Janus.log((media.replaceAudio?"Replacing":"Adding")+" audio track:",stream.getAudioTracks()[0]);var audioTransceiver=null,transceivers=config.pc.getTransceivers();if(transceivers&&0<transceivers.length)for(var i in transceivers){var t=transceivers[i];if(t.sender&&t.sender.track&&"audio"===t.sender.track.kind||t.receiver&&t.receiver.track&&"audio"===t.receiver.track.kind){audioTransceiver=t;break}}audioTransceiver&&audioTransceiver.sender?audioTransceiver.sender.replaceTrack(stream.getAudioTracks()[0]):config.pc.addTrack(stream.getAudioTracks()[0],stream)}else Janus.log((media.replaceAudio?"Replacing":"Adding")+" audio track:",stream.getAudioTracks()[0]),config.pc.addTrack(stream.getAudioTracks()[0],stream);if((!media.update&&isVideoSendEnabled(media)||media.update&&(media.addVideo||media.replaceVideo))&&stream.getVideoTracks()&&stream.getVideoTracks().length)if(config.myStream.addTrack(stream.getVideoTracks()[0]),media.replaceVideo&&("firefox"===Janus.webRTCAdapter.browserDetails.browser||"chrome"===Janus.webRTCAdapter.browserDetails.browser&&72<=Janus.webRTCAdapter.browserDetails.version))for(var index in Janus.log("Replacing video track:",stream.getVideoTracks()[0]),config.pc.getSenders()){var s=config.pc.getSenders()[index];s&&s.track&&"video"===s.track.kind&&s.replaceTrack(stream.getVideoTracks()[0])}else if("firefox"===Janus.webRTCAdapter.browserDetails.browser&&59<=Janus.webRTCAdapter.browserDetails.version){Janus.log((media.replaceVideo?"Replacing":"Adding")+" video track:",stream.getVideoTracks()[0]);var videoTransceiver=null,transceivers=config.pc.getTransceivers();if(transceivers&&0<transceivers.length)for(var i in transceivers){var t=transceivers[i];if(t.sender&&t.sender.track&&"video"===t.sender.track.kind||t.receiver&&t.receiver.track&&"video"===t.receiver.track.kind){videoTransceiver=t;break}}videoTransceiver&&videoTransceiver.sender?videoTransceiver.sender.replaceTrack(stream.getVideoTracks()[0]):config.pc.addTrack(stream.getVideoTracks()[0],stream)}else Janus.log((media.replaceVideo?"Replacing":"Adding")+" video track:",stream.getVideoTracks()[0]),config.pc.addTrack(stream.getVideoTracks()[0],stream)}if(!config.pc){var pc_config={iceServers:iceServers,iceTransportPolicy:iceTransportPolicy,bundlePolicy:bundlePolicy};"chrome"===Janus.webRTCAdapter.browserDetails.browser&&(pc_config.sdpSemantics=72>Janus.webRTCAdapter.browserDetails.version?"plan-b":"unified-plan");var pc_constraints={optional:[{DtlsSrtpKeyAgreement:!0}]};if(!0===ipv6Support&&pc_constraints.optional.push({googIPv6:!0}),callbacks.rtcConstraints&&"object"==typeof callbacks.rtcConstraints)for(var i in Janus.debug("Adding custom PeerConnection constraints:",callbacks.rtcConstraints),callbacks.rtcConstraints)pc_constraints.optional.push(callbacks.rtcConstraints[i]);"edge"===Janus.webRTCAdapter.browserDetails.browser&&(pc_config.bundlePolicy="max-bundle"),Janus.log("Creating PeerConnection"),Janus.debug(pc_constraints),config.pc=new RTCPeerConnection(pc_config,pc_constraints),Janus.debug(config.pc),config.pc.getStats&&(config.volume={},config.bitrate.value="0 kbits/sec"),Janus.log("Preparing local SDP and gathering candidates (trickle="+config.trickle+")"),config.pc.oniceconnectionstatechange=function(e){config.pc&&pluginHandle.iceState(config.pc.iceConnectionState)},config.pc.onicecandidate=function(event){if(null==event.candidate||"edge"===Janus.webRTCAdapter.browserDetails.browser&&0<event.candidate.candidate.indexOf("endOfCandidates"))Janus.log("End of candidates."),config.iceDone=!0,!0===config.trickle?sendTrickleCandidate(handleId,{completed:!0}):sendSDP(handleId,callbacks);else{var candidate={candidate:event.candidate.candidate,sdpMid:event.candidate.sdpMid,sdpMLineIndex:event.candidate.sdpMLineIndex};!0===config.trickle&&sendTrickleCandidate(handleId,candidate)}},config.pc.ontrack=function(event){Janus.log("Handling Remote Track"),Janus.debug(event),event.streams&&(config.remoteStream=event.streams[0],pluginHandle.onremotestream(config.remoteStream),event.track&&!event.track.onended&&(Janus.log("Adding onended callback to track:",event.track),event.track.onended=function(ev){Janus.log("Remote track removed:",ev),config.remoteStream&&(config.remoteStream.removeTrack(ev.target),pluginHandle.onremotestream(config.remoteStream))}))}}if(addTracks&&null!==stream&&void 0!==stream&&(Janus.log("Adding local stream"),stream.getTracks().forEach(function(track){Janus.log("Adding local track:",track),config.pc.addTrack(track,stream)})),isDataEnabled(media)&&!config.dataChannel){Janus.log("Creating data channel");var onDataChannelMessage=function(event){Janus.log("Received message on data channel: "+event.data),pluginHandle.ondata(event.data)},onDataChannelStateChange=function(){var dcState=null===config.dataChannel?"null":config.dataChannel.readyState;Janus.log("State change on data channel: "+dcState),"open"===dcState&&pluginHandle.ondataopen()},onDataChannelError=function(error){Janus.error("Got error on data channel:",error)};config.dataChannel=config.pc.createDataChannel("JanusDataChannel",{ordered:!1}),config.dataChannel.onmessage=onDataChannelMessage,config.dataChannel.onopen=onDataChannelStateChange,config.dataChannel.onclose=onDataChannelStateChange,config.dataChannel.onerror=onDataChannelError}config.myStream&&pluginHandle.onlocalstream(config.myStream),null===jsep||void 0===jsep?createOffer(handleId,media,callbacks):config.pc.setRemoteDescription(jsep).then(function(){if(Janus.log("Remote description accepted!"),config.remoteSdp=jsep.sdp,config.candidates&&0<config.candidates.length){for(var i in config.candidates){var candidate=config.candidates[i];Janus.debug("Adding remote candidate:",candidate),candidate&&!0!==candidate.completed?config.pc.addIceCandidate(candidate):config.pc.addIceCandidate()}config.candidates=[]}createAnswer(handleId,media,callbacks)},callbacks.error)}function prepareWebrtc(handleId,callbacks){callbacks=callbacks||{},callbacks.success="function"==typeof callbacks.success?callbacks.success:Janus.noop,callbacks.error="function"==typeof callbacks.error?callbacks.error:webrtcError;var jsep=callbacks.jsep;callbacks.media=callbacks.media||{audio:!0,video:!0};var media=callbacks.media,pluginHandle=pluginHandles[handleId];if(null===pluginHandle||void 0===pluginHandle||null===pluginHandle.webrtcStuff||void 0===pluginHandle.webrtcStuff)return Janus.warn("Invalid handle"),void callbacks.error("Invalid handle");var config=pluginHandle.webrtcStuff;if(config.trickle=isTrickleEnabled(callbacks.trickle),void 0===config.pc||null===config.pc)media.update=!1,media.keepAudio=!1,media.keepVideo=!1;else if(void 0!==config.pc&&null!==config.pc){if(Janus.log("Updating existing media session"),media.update=!0,null!==callbacks.stream&&void 0!==callbacks.stream)callbacks.stream!==config.myStream&&Janus.log("Renegotiation involves a new external stream");else{if(!media.addAudio)media.removeAudio?(media.keepAudio=!1,media.replaceAudio=!1,media.addAudio=!1,media.audioSend=!1):media.replaceAudio&&(media.keepAudio=!1,media.addAudio=!1,media.removeAudio=!1,media.audioSend=!0);else if(media.keepAudio=!1,media.replaceAudio=!1,media.removeAudio=!1,media.audioSend=!0,config.myStream&&config.myStream.getAudioTracks()&&config.myStream.getAudioTracks().length)return Janus.error("Can't add audio stream, there already is one"),void callbacks.error("Can't add audio stream, there already is one");if(null===config.myStream||void 0===config.myStream?(media.replaceAudio&&(media.keepAudio=!1,media.replaceAudio=!1,media.addAudio=!0,media.audioSend=!0),isAudioSendEnabled(media)&&(media.keepAudio=!1,media.addAudio=!0)):null===config.myStream.getAudioTracks()||void 0===config.myStream.getAudioTracks()||0===config.myStream.getAudioTracks().length?(media.replaceAudio&&(media.keepAudio=!1,media.replaceAudio=!1,media.addAudio=!0,media.audioSend=!0),isAudioSendEnabled(media)&&(media.keepVideo=!1,media.addAudio=!0)):isAudioSendEnabled(media)&&!media.removeAudio&&!media.replaceAudio&&(media.keepAudio=!0),!media.addVideo)media.removeVideo?(media.keepVideo=!1,media.replaceVideo=!1,media.addVideo=!1,media.videoSend=!1):media.replaceVideo&&(media.keepVideo=!1,media.addVideo=!1,media.removeVideo=!1,media.videoSend=!0);else if(media.keepVideo=!1,media.replaceVideo=!1,media.removeVideo=!1,media.videoSend=!0,config.myStream&&config.myStream.getVideoTracks()&&config.myStream.getVideoTracks().length)return Janus.error("Can't add video stream, there already is one"),void callbacks.error("Can't add video stream, there already is one");null===config.myStream||void 0===config.myStream?(media.replaceVideo&&(media.keepVideo=!1,media.replaceVideo=!1,media.addVideo=!0,media.videoSend=!0),isVideoSendEnabled(media)&&(media.keepVideo=!1,media.addVideo=!0)):null===config.myStream.getVideoTracks()||void 0===config.myStream.getVideoTracks()||0===config.myStream.getVideoTracks().length?(media.replaceVideo&&(media.keepVideo=!1,media.replaceVideo=!1,media.addVideo=!0,media.videoSend=!0),isVideoSendEnabled(media)&&(media.keepVideo=!1,media.addVideo=!0)):isVideoSendEnabled(media)&&!media.removeVideo&&!media.replaceVideo&&(media.keepVideo=!0),media.addData&&(media.data=!0)}if(isAudioSendEnabled(media)&&media.keepAudio&&isVideoSendEnabled(media)&&media.keepVideo)return void streamsDone(handleId,jsep,media,callbacks,config.myStream)}if(media.update&&!config.streamExternal){if(media.removeAudio||media.replaceAudio){if(config.myStream&&config.myStream.getAudioTracks()&&config.myStream.getAudioTracks().length){var s=config.myStream.getAudioTracks()[0];Janus.log("Removing audio track:",s),config.myStream.removeTrack(s);try{s.stop()}catch(e){}}if(config.pc.getSenders()&&config.pc.getSenders().length){var ra=!0;if(media.replaceAudio&&("firefox"===Janus.webRTCAdapter.browserDetails.browser||"chrome"===Janus.webRTCAdapter.browserDetails.browser&&72<=Janus.webRTCAdapter.browserDetails.version)&&(ra=!1),ra)for(var index in config.pc.getSenders()){var s=config.pc.getSenders()[index];s&&s.track&&"audio"===s.track.kind&&(Janus.log("Removing audio sender:",s),config.pc.removeTrack(s))}}}if(media.removeVideo||media.replaceVideo){if(config.myStream&&config.myStream.getVideoTracks()&&config.myStream.getVideoTracks().length){var s=config.myStream.getVideoTracks()[0];Janus.log("Removing video track:",s),config.myStream.removeTrack(s);try{s.stop()}catch(e){}}if(config.pc.getSenders()&&config.pc.getSenders().length){var rv=!0;if(media.replaceVideo&&("firefox"===Janus.webRTCAdapter.browserDetails.browser||"chrome"===Janus.webRTCAdapter.browserDetails.browser&&72<=Janus.webRTCAdapter.browserDetails.version)&&(rv=!1),rv)for(var index in config.pc.getSenders()){var s=config.pc.getSenders()[index];s&&s.track&&"video"===s.track.kind&&(Janus.log("Removing video sender:",s),config.pc.removeTrack(s))}}}}if(null!==callbacks.stream&&void 0!==callbacks.stream){var stream=callbacks.stream;if(Janus.log("MediaStream provided by the application"),Janus.debug(stream),media.update&&config.myStream&&config.myStream!==callbacks.stream&&!config.streamExternal){try{var tracks=config.myStream.getTracks();for(var i in tracks){var mst=tracks[i];Janus.log(mst),null!==mst&&void 0!==mst&&mst.stop()}}catch(e){}config.myStream=null}return config.streamExternal=!0,void streamsDone(handleId,jsep,media,callbacks,stream)}if(isAudioSendEnabled(media)||isVideoSendEnabled(media)){var constraints={mandatory:{},optional:[]};pluginHandle.consentDialog(!0);var audioSupport=isAudioSendEnabled(media);!0===audioSupport&&null!=media&&null!=media&&"object"==typeof media.audio&&(audioSupport=media.audio);var videoSupport=isVideoSendEnabled(media);if(!0===videoSupport&&null!=media&&null!=media){var simulcast=!0===callbacks.simulcast;if(simulcast&&!jsep&&(void 0===media.video||!1===media.video)&&(media.video="hires"),media.video&&"screen"!=media.video&&"window"!=media.video){if("object"==typeof media.video)videoSupport=media.video;else{var width=0,height=0,maxHeight=0;"lowres"===media.video?(height=240,maxHeight=240,width=320):"lowres-16:9"===media.video?(height=180,maxHeight=180,width=320):"hires"===media.video||"hires-16:9"===media.video||"hdres"===media.video?(height=720,maxHeight=720,width=1280):"fhdres"===media.video?(height=1080,maxHeight=1080,width=1920):"4kres"===media.video?(height=2160,maxHeight=2160,width=3840):"stdres"===media.video?(height=480,maxHeight=480,width=640):"stdres-16:9"===media.video?(height=360,maxHeight=360,width=640):(Janus.log("Default video setting is stdres 4:3"),height=480,maxHeight=480,width=640),Janus.log("Adding media constraint:",media.video),videoSupport={height:{ideal:height},width:{ideal:width}},Janus.log("Adding video constraint:",videoSupport)}}else if("screen"===media.video||"window"===media.video){function callbackUserMedia(error,stream){pluginHandle.consentDialog(!1),error?callbacks.error(error):streamsDone(handleId,jsep,media,callbacks,stream)}function getScreenMedia(constraints,gsmCallback,useAudio){Janus.log("Adding media constraint (screen capture)"),Janus.debug(constraints),navigator.mediaDevices.getUserMedia(constraints).then(function(stream){useAudio?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(audioStream){stream.addTrack(audioStream.getAudioTracks()[0]),gsmCallback(null,stream)}):gsmCallback(null,stream)}).catch(function(error){pluginHandle.consentDialog(!1),gsmCallback(error)})}if(media.screenshareFrameRate||(media.screenshareFrameRate=3),navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return void navigator.mediaDevices.getDisplayMedia({video:!0}).then(function(stream){pluginHandle.consentDialog(!1),isAudioSendEnabled(media)&&!media.keepAudio?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(audioStream){stream.addTrack(audioStream.getAudioTracks()[0]),streamsDone(handleId,jsep,media,callbacks,stream)}):streamsDone(handleId,jsep,media,callbacks,stream)},function(error){pluginHandle.consentDialog(!1),callbacks.error(error)});if("chrome"===Janus.webRTCAdapter.browserDetails.browser){var chromever=Janus.webRTCAdapter.browserDetails.version,maxver=33;window.navigator.userAgent.match("Linux")&&(maxver=35),26<=chromever&&chromever<=maxver?(constraints={video:{mandatory:{googLeakyBucket:!0,maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:media.screenshareFrameRate,maxFrameRate:media.screenshareFrameRate,chromeMediaSource:"screen"}},audio:isAudioSendEnabled(media)&&!media.keepAudio},getScreenMedia(constraints,callbackUserMedia)):Janus.extension.getScreen(function(error,sourceId){return error?(pluginHandle.consentDialog(!1),callbacks.error(error)):void(constraints={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:media.screenshareFrameRate,maxFrameRate:media.screenshareFrameRate},optional:[{googLeakyBucket:!0},{googTemporalLayeredScreencast:!0}]}},constraints.video.mandatory.chromeMediaSourceId=sourceId,getScreenMedia(constraints,callbackUserMedia,isAudioSendEnabled(media)&&!media.keepAudio))})}else if("firefox"===Janus.webRTCAdapter.browserDetails.browser)if(33<=Janus.webRTCAdapter.browserDetails.version)constraints={video:{mozMediaSource:media.video,mediaSource:media.video},audio:isAudioSendEnabled(media)&&!media.keepAudio},getScreenMedia(constraints,function(err,stream){if(callbackUserMedia(err,stream),!err)var lastTime=stream.currentTime,polly=window.setInterval(function(){stream||window.clearInterval(polly),stream.currentTime==lastTime&&(window.clearInterval(polly),stream.onended&&stream.onended()),lastTime=stream.currentTime},500)});else{var error=new Error("NavigatorUserMediaError");return error.name="Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)",pluginHandle.consentDialog(!1),void callbacks.error(error)}return}}(null===media||void 0===media||"screen"!==media.video)&&navigator.mediaDevices.enumerateDevices().then(function(devices){var audioExist=devices.some(function(device){return"audioinput"===device.kind}),videoExist=isScreenSendEnabled(media)||devices.some(function(device){return"videoinput"===device.kind}),audioSend=isAudioSendEnabled(media),videoSend=isVideoSendEnabled(media),needAudioDevice=isAudioSendRequired(media),needVideoDevice=isVideoSendRequired(media);if(audioSend||videoSend||needAudioDevice||needVideoDevice){var haveAudioDevice=!!audioSend&&audioExist,haveVideoDevice=!!videoSend&&videoExist;if(!haveAudioDevice&&!haveVideoDevice)return pluginHandle.consentDialog(!1),callbacks.error("No capture device found"),!1;if(!haveAudioDevice&&needAudioDevice)return pluginHandle.consentDialog(!1),callbacks.error("Audio capture is required, but no capture device found"),!1;if(!haveVideoDevice&&needVideoDevice)return pluginHandle.consentDialog(!1),callbacks.error("Video capture is required, but no capture device found"),!1}var gumConstraints={audio:audioExist&&!media.keepAudio&&audioSupport,video:videoExist&&!media.keepVideo&&videoSupport};Janus.debug("getUserMedia constraints",gumConstraints),navigator.mediaDevices.getUserMedia(gumConstraints).then(function(stream){pluginHandle.consentDialog(!1),streamsDone(handleId,jsep,media,callbacks,stream)}).catch(function(error){pluginHandle.consentDialog(!1),callbacks.error({code:error.code,name:error.name,message:error.message})})}).catch(function(error){pluginHandle.consentDialog(!1),callbacks.error("enumerateDevices error",error)})}else streamsDone(handleId,jsep,media,callbacks)}function prepareWebrtcPeer(handleId,callbacks){callbacks=callbacks||{},callbacks.success="function"==typeof callbacks.success?callbacks.success:Janus.noop,callbacks.error="function"==typeof callbacks.error?callbacks.error:webrtcError;var jsep=callbacks.jsep,pluginHandle=pluginHandles[handleId];if(null===pluginHandle||void 0===pluginHandle||null===pluginHandle.webrtcStuff||void 0===pluginHandle.webrtcStuff)return Janus.warn("Invalid handle"),void callbacks.error("Invalid handle");var config=pluginHandle.webrtcStuff;if(void 0!==jsep&&null!==jsep){if(null===config.pc)return Janus.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void callbacks.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");config.pc.setRemoteDescription(jsep).then(function(){if(Janus.log("Remote description accepted!"),config.remoteSdp=jsep.sdp,config.candidates&&0<config.candidates.length){for(var i in config.candidates){var candidate=config.candidates[i];Janus.debug("Adding remote candidate:",candidate),candidate&&!0!==candidate.completed?config.pc.addIceCandidate(candidate):config.pc.addIceCandidate()}config.candidates=[]}callbacks.success()},callbacks.error)}else callbacks.error("Invalid JSEP")}function createOffer(handleId,media,callbacks){callbacks=callbacks||{},callbacks.success="function"==typeof callbacks.success?callbacks.success:Janus.noop,callbacks.error="function"==typeof callbacks.error?callbacks.error:Janus.noop;var pluginHandle=pluginHandles[handleId];if(null===pluginHandle||void 0===pluginHandle||null===pluginHandle.webrtcStuff||void 0===pluginHandle.webrtcStuff)return Janus.warn("Invalid handle"),void callbacks.error("Invalid handle");var config=pluginHandle.webrtcStuff,simulcast=!0===callbacks.simulcast;simulcast?Janus.log("Creating offer (iceDone="+config.iceDone+", simulcast="+simulcast+")"):Janus.log("Creating offer (iceDone="+config.iceDone+")");var mediaConstraints={};if("firefox"===Janus.webRTCAdapter.browserDetails.browser&&59<=Janus.webRTCAdapter.browserDetails.version){var audioTransceiver=null,videoTransceiver=null,transceivers=config.pc.getTransceivers();if(transceivers&&0<transceivers.length)for(var i in transceivers){var t=transceivers[i];if(t.sender&&t.sender.track&&"audio"===t.sender.track.kind||t.receiver&&t.receiver.track&&"audio"===t.receiver.track.kind){audioTransceiver||(audioTransceiver=t);continue}if(t.sender&&t.sender.track&&"video"===t.sender.track.kind||t.receiver&&t.receiver.track&&"video"===t.receiver.track.kind){videoTransceiver||(videoTransceiver=t);continue}}var audioSend=isAudioSendEnabled(media),audioRecv=isAudioRecvEnabled(media);audioSend||audioRecv?audioSend&&audioRecv?audioTransceiver&&(audioTransceiver.direction="sendrecv",Janus.log("Setting audio transceiver to sendrecv:",audioTransceiver)):audioSend&&!audioRecv?audioTransceiver&&(audioTransceiver.direction="sendonly",Janus.log("Setting audio transceiver to sendonly:",audioTransceiver)):!audioSend&&audioRecv&&(audioTransceiver?(audioTransceiver.direction="recvonly",Janus.log("Setting audio transceiver to recvonly:",audioTransceiver)):(audioTransceiver=config.pc.addTransceiver("audio",{direction:"recvonly"}),Janus.log("Adding recvonly audio transceiver:",audioTransceiver))):media.removeAudio&&audioTransceiver&&(audioTransceiver.direction="inactive",Janus.log("Setting audio transceiver to inactive:",audioTransceiver));var videoSend=isVideoSendEnabled(media),videoRecv=isVideoRecvEnabled(media);videoSend||videoRecv?videoSend&&videoRecv?videoTransceiver&&(videoTransceiver.direction="sendrecv",Janus.log("Setting video transceiver to sendrecv:",videoTransceiver)):videoSend&&!videoRecv?videoTransceiver&&(videoTransceiver.direction="sendonly",Janus.log("Setting video transceiver to sendonly:",videoTransceiver)):!videoSend&&videoRecv&&(videoTransceiver?(videoTransceiver.direction="recvonly",Janus.log("Setting video transceiver to recvonly:",videoTransceiver)):(videoTransceiver=config.pc.addTransceiver("video",{direction:"recvonly"}),Janus.log("Adding recvonly video transceiver:",videoTransceiver))):media.removeVideo&&videoTransceiver&&(videoTransceiver.direction="inactive",Janus.log("Setting video transceiver to inactive:",videoTransceiver))}else mediaConstraints.offerToReceiveAudio=isAudioRecvEnabled(media),mediaConstraints.offerToReceiveVideo=isVideoRecvEnabled(media);var iceRestart=!0===callbacks.iceRestart;iceRestart&&(mediaConstraints.iceRestart=!0),Janus.debug(mediaConstraints);var sendVideo=isVideoSendEnabled(media);if(sendVideo&&simulcast&&"firefox"===Janus.webRTCAdapter.browserDetails.browser){Janus.log("Enabling Simulcasting for Firefox (RID)");var sender=config.pc.getSenders()[1];Janus.log(sender);var parameters=sender.getParameters();Janus.log(parameters),sender.setParameters({encodings:[{rid:"high",active:!0,priority:"high",maxBitrate:1e6},{rid:"medium",active:!0,priority:"medium",maxBitrate:3e5},{rid:"low",active:!0,priority:"low",maxBitrate:1e5}]})}config.pc.createOffer(mediaConstraints).then(function(offer){if(Janus.debug(offer),Janus.log("Setting local description"),sendVideo&&simulcast&&("chrome"===Janus.webRTCAdapter.browserDetails.browser||"safari"===Janus.webRTCAdapter.browserDetails.browser?(Janus.log("Enabling Simulcasting for Chrome (SDP munging)"),offer.sdp=mungeSdpForSimulcasting(offer.sdp)):"firefox"!==Janus.webRTCAdapter.browserDetails.browser&&Janus.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),config.mySdp=offer.sdp,config.pc.setLocalDescription(offer).catch(callbacks.error),config.mediaConstraints=mediaConstraints,!config.iceDone&&!config.trickle)return void Janus.log("Waiting for all candidates...");Janus.log("Offer ready"),Janus.debug(callbacks);var jsep={type:offer.type,sdp:offer.sdp};callbacks.success(jsep)},callbacks.error)}function createAnswer(handleId,media,callbacks){callbacks=callbacks||{},callbacks.success="function"==typeof callbacks.success?callbacks.success:Janus.noop,callbacks.error="function"==typeof callbacks.error?callbacks.error:Janus.noop;var pluginHandle=pluginHandles[handleId];if(null===pluginHandle||void 0===pluginHandle||null===pluginHandle.webrtcStuff||void 0===pluginHandle.webrtcStuff)return Janus.warn("Invalid handle"),void callbacks.error("Invalid handle");var config=pluginHandle.webrtcStuff,simulcast=!0===callbacks.simulcast;simulcast?Janus.log("Creating answer (iceDone="+config.iceDone+", simulcast="+simulcast+")"):Janus.log("Creating answer (iceDone="+config.iceDone+")");var mediaConstraints=null;if("firefox"===Janus.webRTCAdapter.browserDetails.browser&&59<=Janus.webRTCAdapter.browserDetails.version||"chrome"===Janus.webRTCAdapter.browserDetails.browser&&72<=Janus.webRTCAdapter.browserDetails.version){mediaConstraints={};var audioTransceiver=null,videoTransceiver=null,transceivers=config.pc.getTransceivers();if(transceivers&&0<transceivers.length)for(var i in transceivers){var t=transceivers[i];if(t.sender&&t.sender.track&&"audio"===t.sender.track.kind||t.receiver&&t.receiver.track&&"audio"===t.receiver.track.kind){audioTransceiver||(audioTransceiver=t);continue}if(t.sender&&t.sender.track&&"video"===t.sender.track.kind||t.receiver&&t.receiver.track&&"video"===t.receiver.track.kind){videoTransceiver||(videoTransceiver=t);continue}}var audioSend=isAudioSendEnabled(media),audioRecv=isAudioRecvEnabled(media);audioSend||audioRecv?audioSend&&audioRecv?audioTransceiver&&(audioTransceiver.direction="sendrecv",Janus.log("Setting audio transceiver to sendrecv:",audioTransceiver)):audioSend&&!audioRecv?audioTransceiver&&(audioTransceiver.direction="sendonly",Janus.log("Setting audio transceiver to sendonly:",audioTransceiver)):!audioSend&&audioRecv&&(audioTransceiver?(audioTransceiver.direction="recvonly",Janus.log("Setting audio transceiver to recvonly:",audioTransceiver)):(audioTransceiver=config.pc.addTransceiver("audio",{direction:"recvonly"}),Janus.log("Adding recvonly audio transceiver:",audioTransceiver))):media.removeAudio&&audioTransceiver&&(audioTransceiver.direction="inactive",Janus.log("Setting audio transceiver to inactive:",audioTransceiver));var videoSend=isVideoSendEnabled(media),videoRecv=isVideoRecvEnabled(media);videoSend||videoRecv?videoSend&&videoRecv?videoTransceiver&&(videoTransceiver.direction="sendrecv",Janus.log("Setting video transceiver to sendrecv:",videoTransceiver)):videoSend&&!videoRecv?videoTransceiver&&(videoTransceiver.direction="sendonly",Janus.log("Setting video transceiver to sendonly:",videoTransceiver)):!videoSend&&videoRecv&&(videoTransceiver?(videoTransceiver.direction="recvonly",Janus.log("Setting video transceiver to recvonly:",videoTransceiver)):(videoTransceiver=config.pc.addTransceiver("video",{direction:"recvonly"}),Janus.log("Adding recvonly video transceiver:",videoTransceiver))):media.removeVideo&&videoTransceiver&&(videoTransceiver.direction="inactive",Janus.log("Setting video transceiver to inactive:",videoTransceiver))}else mediaConstraints="firefox"==Janus.webRTCAdapter.browserDetails.browser||"edge"==Janus.webRTCAdapter.browserDetails.browser?{offerToReceiveAudio:isAudioRecvEnabled(media),offerToReceiveVideo:isVideoRecvEnabled(media)}:{mandatory:{OfferToReceiveAudio:isAudioRecvEnabled(media),OfferToReceiveVideo:isVideoRecvEnabled(media)}};Janus.debug(mediaConstraints);var sendVideo=isVideoSendEnabled(media);if(sendVideo&&simulcast&&"firefox"===Janus.webRTCAdapter.browserDetails.browser){Janus.log("Enabling Simulcasting for Firefox (RID)");var sender=config.pc.getSenders()[1];Janus.log(sender);var parameters=sender.getParameters();Janus.log(parameters),sender.setParameters({encodings:[{rid:"high",active:!0,priority:"high",maxBitrate:1e6},{rid:"medium",active:!0,priority:"medium",maxBitrate:3e5},{rid:"low",active:!0,priority:"low",maxBitrate:1e5}]})}config.pc.createAnswer(mediaConstraints).then(function(answer){if(Janus.debug(answer),Janus.log("Setting local description"),sendVideo&&simulcast&&("chrome"===Janus.webRTCAdapter.browserDetails.browser?Janus.warn("simulcast=true, but this is an answer, and video breaks in Chrome if we enable it"):"firefox"!==Janus.webRTCAdapter.browserDetails.browser&&Janus.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),config.mySdp=answer.sdp,config.pc.setLocalDescription(answer).catch(callbacks.error),config.mediaConstraints=mediaConstraints,!config.iceDone&&!config.trickle)return void Janus.log("Waiting for all candidates...");var jsep={type:answer.type,sdp:answer.sdp};callbacks.success(jsep)},callbacks.error)}function sendSDP(handleId,callbacks){callbacks=callbacks||{},callbacks.success="function"==typeof callbacks.success?callbacks.success:Janus.noop,callbacks.error="function"==typeof callbacks.error?callbacks.error:Janus.noop;var pluginHandle=pluginHandles[handleId];if(null===pluginHandle||void 0===pluginHandle||null===pluginHandle.webrtcStuff||void 0===pluginHandle.webrtcStuff)return void Janus.warn("Invalid handle, not sending anything");var config=pluginHandle.webrtcStuff;return Janus.log("Sending offer/answer SDP..."),null===config.mySdp||void 0===config.mySdp?void Janus.warn("Local SDP instance is invalid, not sending anything..."):void(config.mySdp={type:config.pc.localDescription.type,sdp:config.pc.localDescription.sdp},!1===config.trickle&&(config.mySdp.trickle=!1),Janus.debug(callbacks),config.sdpSent=!0,callbacks.success(config.mySdp))}function getVolume(handleId,remote){var pluginHandle=pluginHandles[handleId];if(null===pluginHandle||void 0===pluginHandle||null===pluginHandle.webrtcStuff||void 0===pluginHandle.webrtcStuff)return Janus.warn("Invalid handle"),0;var stream=remote?"remote":"local",config=pluginHandle.webrtcStuff;return config.volume[stream]||(config.volume[stream]={value:0}),config.pc.getStats&&"chrome"===Janus.webRTCAdapter.browserDetails.browser?remote&&(null===config.remoteStream||void 0===config.remoteStream)?(Janus.warn("Remote stream unavailable"),0):remote||null!==config.myStream&&void 0!==config.myStream?null===config.volume[stream].timer||void 0===config.volume[stream].timer?(Janus.log("Starting "+stream+" volume monitor"),config.volume[stream].timer=setInterval(function(){config.pc.getStats(function(stats){for(var res,results=stats.result(),i=0;i<results.length;i++)res=results[i],"ssrc"==res.type&&(remote&&res.stat("audioOutputLevel")?config.volume[stream].value=parseInt(res.stat("audioOutputLevel")):!remote&&res.stat("audioInputLevel")&&(config.volume[stream].value=parseInt(res.stat("audioInputLevel"))))})},200),0):config.volume[stream].value:(Janus.warn("Local stream unavailable"),0):(Janus.warn("Getting the "+stream+" volume unsupported by browser"),0)}function isMuted(handleId,video){var pluginHandle=pluginHandles[handleId];if(null===pluginHandle||void 0===pluginHandle||null===pluginHandle.webrtcStuff||void 0===pluginHandle.webrtcStuff)return Janus.warn("Invalid handle"),!0;var config=pluginHandle.webrtcStuff;return null===config.pc||void 0===config.pc?(Janus.warn("Invalid PeerConnection"),!0):void 0===config.myStream||null===config.myStream?(Janus.warn("Invalid local MediaStream"),!0):video?null===config.myStream.getVideoTracks()||void 0===config.myStream.getVideoTracks()||0===config.myStream.getVideoTracks().length?(Janus.warn("No video track"),!0):!config.myStream.getVideoTracks()[0].enabled:null===config.myStream.getAudioTracks()||void 0===config.myStream.getAudioTracks()||0===config.myStream.getAudioTracks().length?(Janus.warn("No audio track"),!0):!config.myStream.getAudioTracks()[0].enabled}function mute(handleId,video,mute){var pluginHandle=pluginHandles[handleId];if(null===pluginHandle||void 0===pluginHandle||null===pluginHandle.webrtcStuff||void 0===pluginHandle.webrtcStuff)return Janus.warn("Invalid handle"),!1;var config=pluginHandle.webrtcStuff;return null===config.pc||void 0===config.pc?(Janus.warn("Invalid PeerConnection"),!1):void 0===config.myStream||null===config.myStream?(Janus.warn("Invalid local MediaStream"),!1):video?null===config.myStream.getVideoTracks()||void 0===config.myStream.getVideoTracks()||0===config.myStream.getVideoTracks().length?(Janus.warn("No video track"),!1):(config.myStream.getVideoTracks()[0].enabled=!mute,!0):null===config.myStream.getAudioTracks()||void 0===config.myStream.getAudioTracks()||0===config.myStream.getAudioTracks().length?(Janus.warn("No audio track"),!1):(config.myStream.getAudioTracks()[0].enabled=!mute,!0)}function getBitrate(handleId){var pluginHandle=pluginHandles[handleId];if(null===pluginHandle||void 0===pluginHandle||null===pluginHandle.webrtcStuff||void 0===pluginHandle.webrtcStuff)return Janus.warn("Invalid handle"),"Invalid handle";var config=pluginHandle.webrtcStuff;return null===config.pc||void 0===config.pc?"Invalid PeerConnection":config.pc.getStats?null===config.bitrate.timer||void 0===config.bitrate.timer?(Janus.log("Starting bitrate timer (via getStats)"),config.bitrate.timer=setInterval(function(){config.pc.getStats().then(function(stats){stats.forEach(function(res){if(res){var inStats=!1;if(("video"===res.mediaType||-1<res.id.toLowerCase().indexOf("video"))&&"inbound-rtp"===res.type&&0>res.id.indexOf("rtcp")?inStats=!0:"ssrc"==res.type&&res.bytesReceived&&("VP8"===res.googCodecName||""===res.googCodecName)&&(inStats=!0),inStats)if(config.bitrate.bsnow=res.bytesReceived,config.bitrate.tsnow=res.timestamp,null===config.bitrate.bsbefore||null===config.bitrate.tsbefore)config.bitrate.bsbefore=config.bitrate.bsnow,config.bitrate.tsbefore=config.bitrate.tsnow;else{var timePassed=config.bitrate.tsnow-config.bitrate.tsbefore;"safari"==Janus.webRTCAdapter.browserDetails.browser&&(timePassed/=1e3);var bitRate=Math.round(8*(config.bitrate.bsnow-config.bitrate.bsbefore)/timePassed);"safari"===Janus.webRTCAdapter.browserDetails.browser&&(bitRate=parseInt(bitRate/1e3)),config.bitrate.value=bitRate+" kbits/sec",config.bitrate.bsbefore=config.bitrate.bsnow,config.bitrate.tsbefore=config.bitrate.tsnow}}})})},1e3),"0 kbits/sec"):config.bitrate.value:(Janus.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser")}function webrtcError(error){Janus.error("WebRTC error:",error)}function cleanupWebrtc(handleId,hangupRequest){Janus.log("Cleaning WebRTC stuff");var pluginHandle=pluginHandles[handleId];if(null!==pluginHandle&&void 0!==pluginHandle){var config=pluginHandle.webrtcStuff;if(null!==config&&void 0!==config){if(!0===hangupRequest){var request={janus:"hangup",transaction:Janus.randomString(12)};null!==pluginHandle.token&&void 0!==pluginHandle.token&&(request.token=pluginHandle.token),null!==apisecret&&void 0!==apisecret&&(request.apisecret=apisecret),Janus.debug("Sending hangup request (handle="+handleId+"):"),Janus.debug(request),websockets?(request.session_id=sessionId,request.handle_id=handleId,ws.send(JSON.stringify(request))):Janus.httpAPICall(server+"/"+sessionId+"/"+handleId,{verb:"POST",withCredentials:withCredentials,body:request})}config.remoteStream=null,config.volume&&(config.volume.local&&config.volume.local.timer&&clearInterval(config.volume.local.timer),config.volume.remote&&config.volume.remote.timer&&clearInterval(config.volume.remote.timer)),config.volume={},config.bitrate.timer&&clearInterval(config.bitrate.timer),config.bitrate.timer=null,config.bitrate.bsnow=null,config.bitrate.bsbefore=null,config.bitrate.tsnow=null,config.bitrate.tsbefore=null,config.bitrate.value=null;try{if(!config.streamExternal&&null!==config.myStream&&void 0!==config.myStream){Janus.log("Stopping local stream tracks");var tracks=config.myStream.getTracks();for(var i in tracks){var mst=tracks[i];Janus.log(mst),null!==mst&&void 0!==mst&&mst.stop()}}}catch(e){}if(config.streamExternal=!1,config.myStream=null,null!=config.pc)try{for(var index in config.pc.getSenders()){var s=config.pc.getSenders()[index];s&&s.track&&(Janus.log("Removing track:",s.track),config.pc.removeTrack(s))}config.pc.close(),Janus.log("RTCPeerConnection.close()")}catch(e){Janus.error("config.pc.close() error:"+e)}config.pc=null,config.candidates=null,config.mySdp=null,config.remoteSdp=null,config.iceDone=!1,config.dataChannel=null,config.dtmfSender=null}pluginHandle.oncleanup()}}function mungeSdpForSimulcasting(sdp){for(var mline,lines=sdp.split("\r\n"),video=!1,ssrc=[-1],ssrc_fid=[-1],cname=null,msid=null,mslabel=null,label=null,insertAt=-1,i=0;i<lines.length;i++){if(mline=lines[i].match(/m=(\w+) */),mline){var medium=mline[1];if("video"===medium){if(0>ssrc[0])video=!0;else{insertAt=i;break}}else if(-1<ssrc[0]){insertAt=i;break}continue}if(video){var fid=lines[i].match(/a=ssrc-group:FID (\d+) (\d+)/);if(fid){ssrc[0]=fid[1],ssrc_fid[0]=fid[2],lines.splice(i,1),i--;continue}if(ssrc[0]){var match=lines[i].match("a=ssrc:"+ssrc[0]+" cname:(.+)");if(match&&(cname=match[1]),match=lines[i].match("a=ssrc:"+ssrc[0]+" msid:(.+)"),match&&(msid=match[1]),match=lines[i].match("a=ssrc:"+ssrc[0]+" mslabel:(.+)"),match&&(mslabel=match[1]),match=lines[i].match("a=ssrc:"+ssrc[0]+" label:(.+)"),match&&(label=match[1]),0===lines[i].indexOf("a=ssrc:"+ssrc_fid[0])){lines.splice(i,1),i--;continue}if(0===lines[i].indexOf("a=ssrc:"+ssrc[0])){lines.splice(i,1),i--;continue}}if(0==lines[i].length){lines.splice(i,1),i--;continue}}}if(0>ssrc[0]){insertAt=-1,video=!1;for(var mline,i=0;i<lines.length;i++){if(mline=lines[i].match(/m=(\w+) */),mline){var medium=mline[1];if("video"===medium){if(0>ssrc[0])video=!0;else{insertAt=i;break}}else if(-1<ssrc[0]){insertAt=i;break}continue}if(video){if(0>ssrc[0]){var value=lines[i].match(/a=ssrc:(\d+)/);if(value){ssrc[0]=value[1],lines.splice(i,1),i--;continue}}else{var match=lines[i].match("a=ssrc:"+ssrc[0]+" cname:(.+)");if(match&&(cname=match[1]),match=lines[i].match("a=ssrc:"+ssrc[0]+" msid:(.+)"),match&&(msid=match[1]),match=lines[i].match("a=ssrc:"+ssrc[0]+" mslabel:(.+)"),match&&(mslabel=match[1]),match=lines[i].match("a=ssrc:"+ssrc[0]+" label:(.+)"),match&&(label=match[1]),0===lines[i].indexOf("a=ssrc:"+ssrc_fid[0])){lines.splice(i,1),i--;continue}if(0===lines[i].indexOf("a=ssrc:"+ssrc[0])){lines.splice(i,1),i--;continue}}if(0==lines[i].length){lines.splice(i,1),i--;continue}}}}if(0>ssrc[0])return Janus.warn("Couldn't find the video SSRC, simulcasting NOT enabled"),sdp;0>insertAt&&(insertAt=lines.length),ssrc[1]=Math.floor(4294967295*Math.random()),ssrc[2]=Math.floor(4294967295*Math.random()),ssrc_fid[1]=Math.floor(4294967295*Math.random()),ssrc_fid[2]=Math.floor(4294967295*Math.random());for(var i=0;i<ssrc.length;i++)cname&&(lines.splice(insertAt,0,"a=ssrc:"+ssrc[i]+" cname:"+cname),insertAt++),msid&&(lines.splice(insertAt,0,"a=ssrc:"+ssrc[i]+" msid:"+msid),insertAt++),mslabel&&(lines.splice(insertAt,0,"a=ssrc:"+ssrc[i]+" mslabel:"+mslabel),insertAt++),label&&(lines.splice(insertAt,0,"a=ssrc:"+ssrc[i]+" label:"+label),insertAt++),cname&&(lines.splice(insertAt,0,"a=ssrc:"+ssrc_fid[i]+" cname:"+cname),insertAt++),msid&&(lines.splice(insertAt,0,"a=ssrc:"+ssrc_fid[i]+" msid:"+msid),insertAt++),mslabel&&(lines.splice(insertAt,0,"a=ssrc:"+ssrc_fid[i]+" mslabel:"+mslabel),insertAt++),label&&(lines.splice(insertAt,0,"a=ssrc:"+ssrc_fid[i]+" label:"+label),insertAt++);return lines.splice(insertAt,0,"a=ssrc-group:FID "+ssrc[2]+" "+ssrc_fid[2]),lines.splice(insertAt,0,"a=ssrc-group:FID "+ssrc[1]+" "+ssrc_fid[1]),lines.splice(insertAt,0,"a=ssrc-group:FID "+ssrc[0]+" "+ssrc_fid[0]),lines.splice(insertAt,0,"a=ssrc-group:SIM "+ssrc[0]+" "+ssrc[1]+" "+ssrc[2]),sdp=lines.join("\r\n"),sdp.endsWith("\r\n")||(sdp+="\r\n"),sdp}function isAudioSendEnabled(media){return Janus.debug("isAudioSendEnabled:",media),void 0===media||null===media||!1!==media.audio&&(void 0===media.audioSend||null===media.audioSend||!0===media.audioSend)}function isAudioSendRequired(media){return Janus.debug("isAudioSendRequired:",media),void 0!==media&&null!==media&&!1!==media.audio&&!1!==media.audioSend&&void 0!==media.failIfNoAudio&&null!==media.failIfNoAudio&&!0===media.failIfNoAudio}function isAudioRecvEnabled(media){return Janus.debug("isAudioRecvEnabled:",media),void 0===media||null===media||!1!==media.audio&&(void 0===media.audioRecv||null===media.audioRecv||!0===media.audioRecv)}function isVideoSendEnabled(media){return Janus.debug("isVideoSendEnabled:",media),void 0===media||null===media||!1!==media.video&&(void 0===media.videoSend||null===media.videoSend||!0===media.videoSend)}function isVideoSendRequired(media){return Janus.debug("isVideoSendRequired:",media),void 0!==media&&null!==media&&!1!==media.video&&!1!==media.videoSend&&void 0!==media.failIfNoVideo&&null!==media.failIfNoVideo&&!0===media.failIfNoVideo}function isVideoRecvEnabled(media){return Janus.debug("isVideoRecvEnabled:",media),void 0===media||null===media||!1!==media.video&&(void 0===media.videoRecv||null===media.videoRecv||!0===media.videoRecv)}function isScreenSendEnabled(media){if(Janus.debug("isScreenSendEnabled:",media),void 0===media||null===media)return!1;if("object"!=typeof media.video||"object"!=typeof media.video.mandatory)return!1;var constraints=media.video.mandatory;return constraints.chromeMediaSource?"desktop"===constraints.chromeMediaSource||"screen"===constraints.chromeMediaSource:constraints.mozMediaSource?"window"===constraints.mozMediaSource||"screen"===constraints.mozMediaSource:!!constraints.mediaSource&&("window"===constraints.mediaSource||"screen"===constraints.mediaSource)}function isDataEnabled(media){return Janus.debug("isDataEnabled:",media),"edge"==Janus.webRTCAdapter.browserDetails.browser?(Janus.warn("Edge doesn't support data channels yet"),!1):void 0!==media&&null!==media&&!0===media.data}function isTrickleEnabled(trickle){return Janus.debug("isTrickleEnabled:",trickle),void 0===trickle||null===trickle||!0===trickle}if(void 0===Janus.initDone)return gatewayCallbacks.error("Library not initialized"),{};if(!Janus.isWebrtcSupported())return gatewayCallbacks.error("WebRTC not supported by this browser"),{};if(Janus.log("Library initialized: "+Janus.initDone),gatewayCallbacks=gatewayCallbacks||{},gatewayCallbacks.success="function"==typeof gatewayCallbacks.success?gatewayCallbacks.success:Janus.noop,gatewayCallbacks.error="function"==typeof gatewayCallbacks.error?gatewayCallbacks.error:Janus.noop,gatewayCallbacks.destroyed="function"==typeof gatewayCallbacks.destroyed?gatewayCallbacks.destroyed:Janus.noop,null===gatewayCallbacks.server||void 0===gatewayCallbacks.server)return gatewayCallbacks.error("Invalid server url"),{};var websockets=!1,ws=null,wsHandlers={},wsKeepaliveTimeoutId=null,servers=null,serversIndex=0,server=gatewayCallbacks.server;Janus.isArray(server)?(Janus.log("Multiple servers provided ("+server.length+"), will use the first that works"),server=null,servers=gatewayCallbacks.server,Janus.debug(servers)):0===server.indexOf("ws")?(websockets=!0,Janus.log("Using WebSockets to contact Janus: "+server)):(websockets=!1,Janus.log("Using REST API to contact Janus 0.6.0: "+server));var iceServers=gatewayCallbacks.iceServers;void 0===iceServers||null===iceServers?iceServers=[{urls:"stun:stun.l.google.com:19302"}]:Janus.log("Using iceServers provided by SDK eKYC Video "+iceServers[0].urls);var iceTransportPolicy=gatewayCallbacks.iceTransportPolicy,bundlePolicy=gatewayCallbacks.bundlePolicy,ipv6Support=gatewayCallbacks.ipv6;(void 0===ipv6Support||null===ipv6Support)&&(ipv6Support=!1);var withCredentials=!1;void 0!==gatewayCallbacks.withCredentials&&null!==gatewayCallbacks.withCredentials&&(withCredentials=!0===gatewayCallbacks.withCredentials);var maxev=10;void 0!==gatewayCallbacks.max_poll_events&&null!==gatewayCallbacks.max_poll_events&&(maxev=gatewayCallbacks.max_poll_events),1>maxev&&(maxev=1);var token=null;void 0!==gatewayCallbacks.token&&null!==gatewayCallbacks.token&&(token=gatewayCallbacks.token);var apisecret=null;void 0!==gatewayCallbacks.apisecret&&null!==gatewayCallbacks.apisecret&&(apisecret=gatewayCallbacks.apisecret),this.destroyOnUnload=!0,void 0!==gatewayCallbacks.destroyOnUnload&&null!==gatewayCallbacks.destroyOnUnload&&(this.destroyOnUnload=!0===gatewayCallbacks.destroyOnUnload);var keepAlivePeriod=25e3;void 0!==gatewayCallbacks.keepAlivePeriod&&null!==gatewayCallbacks.keepAlivePeriod&&(keepAlivePeriod=gatewayCallbacks.keepAlivePeriod),isNaN(keepAlivePeriod)&&(keepAlivePeriod=25e3);var longPollTimeout=6e4;void 0!==gatewayCallbacks.longPollTimeout&&null!==gatewayCallbacks.longPollTimeout&&(longPollTimeout=gatewayCallbacks.longPollTimeout),isNaN(longPollTimeout)&&(longPollTimeout=6e4);var connected=!1,sessionId=null,pluginHandles={},that=this,retries=0,transactions={};createSession(gatewayCallbacks),this.getServer=function(){return server},this.isConnected=function(){return connected},this.reconnect=function(callbacks){callbacks=callbacks||{},callbacks.success="function"==typeof callbacks.success?callbacks.success:Janus.noop,callbacks.error="function"==typeof callbacks.error?callbacks.error:Janus.noop,callbacks.reconnect=!0,createSession(callbacks)},this.getSessionId=function(){return sessionId},this.destroy=function(callbacks){destroySession(callbacks)},this.attach=function(callbacks){createHandle(callbacks)}}